<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J13LHWFT3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J13LHWFT3');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo_small.png">
    <title>Team Chat - ALL PLAYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .chat-container {
            height: calc(100vh - 380px);
            min-height: 300px;
        }
        @media (max-width: 640px) {
            .chat-container {
                height: calc(100vh - 320px);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Team Admin Banner -->
        <div id="team-banner" class="mb-6"></div>

        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden flex flex-col">
            <!-- Chat Header -->
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <h2 class="text-lg font-bold text-gray-900">Team Chat</h2>
                <button id="refresh-btn"
                    class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="chat-container overflow-y-auto p-4 space-y-4">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-500">Loading messages...</p>
                </div>
            </div>

            <!-- Load More Button (hidden by default) -->
            <div id="load-more-container" class="hidden px-4 py-2 border-t border-gray-100">
                <button id="load-more-btn"
                    class="w-full text-sm text-primary-600 hover:text-primary-700 font-medium py-2">
                    Load older messages...
                </button>
            </div>

            <!-- Composer -->
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex gap-2">
                    <input type="text" id="message-input"
                        placeholder="Type a message..."
                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        maxlength="2000">
                    <button id="send-btn"
                        class="px-5 py-2.5 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        Send
                    </button>
                </div>
                <div id="send-error" class="hidden mt-2 text-sm text-red-600"></div>
                <div class="mt-1.5 text-xs text-gray-400">
                    <span class="hidden sm:inline">Formatting: </span><code class="bg-gray-100 px-1 rounded">*bold*</code> <code class="bg-gray-100 px-1 rounded">_italic_</code> <code class="bg-gray-100 px-1 rounded">~strike~</code> <code class="bg-gray-100 px-1 rounded">`code`</code> â€¢ URLs auto-link
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Edit Message</h3>
            <textarea id="edit-textarea" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"
                maxlength="2000"></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="edit-cancel-btn"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                    Cancel
                </button>
                <button id="edit-save-btn"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderHeader, renderFooter, escapeHtml } from './js/utils.js?v=8';
        import { checkAuth } from './js/auth.js';
        import { getTeam, getUserProfile, getChatMessages, postChatMessage, editChatMessage, deleteChatMessage, canAccessTeamChat, canModerateChat, updateChatLastRead } from './js/db.js';
        import { renderTeamAdminBanner } from './js/team-admin-banner.js';

        renderFooter(document.getElementById('footer-container'));

        /**
         * Format message text with simple markdown-like syntax:
         * - Auto-link URLs
         * - *bold*
         * - _italic_
         * - ~strikethrough~
         * - `code`
         */
        function formatMessageText(text) {
            // First escape HTML to prevent XSS
            let formatted = escapeHtml(text);

            // Auto-link URLs (must come before other formatting)
            // Matches http://, https://, and www. URLs
            formatted = formatted.replace(
                /(\bhttps?:\/\/[^\s<]+[^\s<.,;:!?"'\])>]|\bwww\.[^\s<]+[^\s<.,;:!?"'\])>])/gi,
                (url) => {
                    const href = url.startsWith('www.') ? 'https://' + url : url;
                    return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:text-primary-800 underline">${url}</a>`;
                }
            );

            // Code (backticks) - must come before other inline formatting
            formatted = formatted.replace(
                /`([^`]+)`/g,
                '<code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded text-xs font-mono">$1</code>'
            );

            // Bold (*text*)
            formatted = formatted.replace(
                /\*([^*]+)\*/g,
                '<strong>$1</strong>'
            );

            // Italic (_text_)
            formatted = formatted.replace(
                /\b_([^_]+)_\b/g,
                '<em>$1</em>'
            );

            // Strikethrough (~text~)
            formatted = formatted.replace(
                /~([^~]+)~/g,
                '<del class="text-gray-500">$1</del>'
            );

            return formatted;
        }

        // Simple header for parents (no edit options)
        function renderParentChatHeader(container, team) {
            const name = team?.name || 'Team';
            const photoUrl = team?.photoUrl || '';
            const sport = team?.sport || '';

            container.innerHTML = `
                <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="p-5 bg-gradient-to-r from-gray-50 to-white">
                        <div class="flex items-center gap-4">
                            ${photoUrl
                                ? `<img src="${escapeHtml(photoUrl)}" alt="${escapeHtml(name)}" class="w-14 h-14 rounded-xl object-cover border-2 border-gray-200 shadow-sm">`
                                : `<div class="w-14 h-14 rounded-xl bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center border-2 border-gray-200 shadow-sm">
                                    <span class="text-xl font-bold text-primary-600">${escapeHtml(name.charAt(0))}</span>
                                  </div>`
                            }
                            <div class="min-w-0 flex-1">
                                <div class="text-xl font-bold text-gray-900 truncate">${escapeHtml(name)}</div>
                                ${sport ? `<div class="text-sm text-gray-500">${escapeHtml(sport)}</div>` : ''}
                            </div>
                            <a href="parent-dashboard.html" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 hover:text-primary-700 hover:bg-gray-100 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v8a2 2 0 002 2h4"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H9"></path>
                                </svg>
                                <span class="hidden sm:inline">Back</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        // State
        let currentUser = null;
        let currentUserProfile = null;
        let currentTeam = null;
        let teamId = null;
        let messages = [];
        let lastDoc = null;
        let hasMoreMessages = true;
        let canModerate = false;
        const senderPhotoCache = new Map();

        // Get teamId from URL
        function getTeamIdFromUrl() {
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.replace('#', ''));
            return params.get('teamId');
        }

        // Initialize
        checkAuth(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            renderHeader(document.getElementById('header-container'), user);

            teamId = getTeamIdFromUrl();
            if (!teamId) {
                alert('No team specified');
                window.location.href = 'dashboard.html';
                return;
            }

            try {
                // Load team
                currentTeam = await getTeam(teamId);
                if (!currentTeam) {
                    alert('Team not found');
                    window.location.href = 'dashboard.html';
                    return;
                }
                currentTeam.id = teamId;

                // Load user profile
                currentUserProfile = await getUserProfile(user.uid);
                if (currentUserProfile?.photoUrl) {
                    senderPhotoCache.set(user.uid, currentUserProfile.photoUrl);
                }

                // Check access
                const userWithProfile = {
                    ...user,
                    parentOf: currentUserProfile?.parentOf || [],
                    isAdmin: currentUserProfile?.isAdmin || false
                };

                if (!canAccessTeamChat(userWithProfile, currentTeam)) {
                    alert('You do not have access to this team chat');
                    window.location.href = 'dashboard.html';
                    return;
                }

                canModerate = canModerateChat(userWithProfile, currentTeam);

                // Render banner only for owners/admins, simple header for parents
                if (canModerate) {
                    renderTeamAdminBanner(document.getElementById('team-banner'), {
                        team: currentTeam,
                        teamId: teamId,
                        active: 'chat'
                    });
                } else {
                    // Simple header for parents (no edit options)
                    renderParentChatHeader(document.getElementById('team-banner'), currentTeam);
                }

                // Load messages
                await loadMessages();

                // Setup event listeners
                setupEventListeners();

            } catch (error) {
                console.error('Error initializing chat:', error);
                showError('Failed to load chat. Please try again.');
            }
        });

        async function loadMessages(loadMore = false) {
            try {
                if (!loadMore) {
                    document.getElementById('messages-container').innerHTML = `
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading messages...</p>
                        </div>
                    `;
                }

                const options = { limit: 50 };
                if (loadMore && lastDoc) {
                    options.startAfterDoc = lastDoc;
                }

                const newMessages = await getChatMessages(teamId, options);

                if (newMessages.length < 50) {
                    hasMoreMessages = false;
                }

                if (newMessages.length > 0) {
                    lastDoc = newMessages[newMessages.length - 1]._doc;
                }

                if (loadMore) {
                    // Prepend older messages
                    messages = [...newMessages.reverse(), ...messages];
                } else {
                    // Initial load - reverse to show oldest first
                    messages = newMessages.reverse();
                    lastDoc = newMessages.length > 0 ? newMessages[0]._doc : null;
                }

                await hydrateSenderPhotos(messages);
                renderMessages();
                updateLoadMoreButton();

                if (!loadMore) {
                    scrollToBottom();
                    // Mark messages as read
                    if (currentUser?.uid) {
                        updateChatLastRead(currentUser.uid, teamId).catch(err =>
                            console.warn('Failed to update last read:', err)
                        );
                    }
                }

            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messages-container').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-4">Failed to load messages</p>
                        <button onclick="location.reload()" class="text-primary-600 hover:text-primary-700 font-medium">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="font-medium">No messages yet</p>
                        <p class="text-sm">Be the first to send a message!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
        }

        async function hydrateSenderPhotos(messageList) {
            const missing = new Set();
            messageList.forEach(msg => {
                if (!msg.senderPhotoUrl && msg.senderId && !senderPhotoCache.has(msg.senderId)) {
                    missing.add(msg.senderId);
                }
            });

            if (missing.size === 0) return;

            await Promise.all(Array.from(missing).map(async (senderId) => {
                try {
                    const profile = await getUserProfile(senderId);
                    if (profile?.photoUrl) {
                        senderPhotoCache.set(senderId, profile.photoUrl);
                    } else {
                        senderPhotoCache.set(senderId, null);
                    }
                } catch (err) {
                    console.warn('Failed to load sender profile for chat avatar:', err);
                    senderPhotoCache.set(senderId, null);
                }
            }));

            messageList.forEach(msg => {
                if (!msg.senderPhotoUrl && msg.senderId && senderPhotoCache.has(msg.senderId)) {
                    msg.senderPhotoUrl = senderPhotoCache.get(msg.senderId);
                }
            });
        }

        function renderMessage(msg) {
            const isOwn = msg.senderId === currentUser.uid;
            const isDeleted = msg.deleted === true;
            const displayName = msg.senderName || msg.senderEmail || 'Unknown';
            const timestamp = msg.createdAt?.toDate ?
                msg.createdAt.toDate().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : '';
            const date = msg.createdAt?.toDate ?
                msg.createdAt.toDate().toLocaleDateString() : '';

            if (isDeleted) {
                return `
                    <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[75%] px-4 py-2 rounded-lg bg-gray-100 text-gray-400 italic text-sm">
                            Message removed
                        </div>
                    </div>
                `;
            }

            const avatar = msg.senderPhotoUrl
                ? `<img src="${escapeHtml(msg.senderPhotoUrl)}" class="w-8 h-8 rounded-full object-cover">`
                : `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                     <span class="text-xs font-bold text-gray-600">${escapeHtml(displayName.charAt(0).toUpperCase())}</span>
                   </div>`;

            const canEdit = isOwn;
            const canDelete = isOwn || canModerate;

            const actions = [];
            if (canEdit) {
                actions.push(`<button onclick="window.editMessage('${msg.id}')" class="text-gray-400 hover:text-primary-600 text-xs">Edit</button>`);
            }
            if (canDelete) {
                actions.push(`<button onclick="window.deleteMessage('${msg.id}')" class="text-gray-400 hover:text-red-600 text-xs">Delete</button>`);
            }

            const bubbleClass = isOwn
                ? 'bg-primary-100 text-gray-900'
                : 'bg-gray-100 text-gray-900';

            if (isOwn) {
                return `
                    <div class="flex justify-end gap-2">
                        <div class="max-w-[75%]">
                            <div class="text-xs text-gray-500 text-right mb-1">
                                ${msg.editedAt ? '<span class="italic">(edited)</span> ' : ''}${timestamp}
                            </div>
                            <div class="${bubbleClass} rounded-lg px-4 py-2 rounded-br-sm">
                                <p class="text-sm whitespace-pre-wrap break-words">${formatMessageText(msg.text)}</p>
                            </div>
                            ${actions.length > 0 ? `
                                <div class="flex justify-end gap-2 mt-1">
                                    ${actions.join(' ')}
                                </div>
                            ` : ''}
                        </div>
                        ${avatar}
                    </div>
                `;
            } else {
                return `
                    <div class="flex justify-start gap-2">
                        ${avatar}
                        <div class="max-w-[75%]">
                            <div class="text-xs text-gray-500 mb-1">
                                <span class="font-medium">${escapeHtml(displayName)}</span>
                                ${msg.editedAt ? '<span class="italic">(edited)</span>' : ''}
                                <span class="ml-1">${timestamp}</span>
                            </div>
                            <div class="${bubbleClass} rounded-lg px-4 py-2 rounded-bl-sm">
                                <p class="text-sm whitespace-pre-wrap break-words">${formatMessageText(msg.text)}</p>
                            </div>
                            ${actions.length > 0 ? `
                                <div class="flex gap-2 mt-1">
                                    ${actions.join(' ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        function updateLoadMoreButton() {
            const container = document.getElementById('load-more-container');
            if (hasMoreMessages && messages.length >= 50) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            // Use double requestAnimationFrame to ensure scroll happens after full render
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            });
        }

        function showError(message) {
            const errorEl = document.getElementById('send-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function setupEventListeners() {
            // Send button
            document.getElementById('send-btn').addEventListener('click', sendMessage);

            // Enter key to send
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                const btn = document.getElementById('refresh-btn');
                btn.disabled = true;
                messages = [];
                lastDoc = null;
                hasMoreMessages = true;
                await loadMessages();
                btn.disabled = false;
            });

            // Load more button
            document.getElementById('load-more-btn').addEventListener('click', async () => {
                const btn = document.getElementById('load-more-btn');
                btn.disabled = true;
                btn.textContent = 'Loading...';

                const container = document.getElementById('messages-container');
                const scrollHeightBefore = container.scrollHeight;

                await loadMessages(true);

                // Maintain scroll position
                const scrollHeightAfter = container.scrollHeight;
                container.scrollTop = scrollHeightAfter - scrollHeightBefore;

                btn.disabled = false;
                btn.textContent = 'Load older messages...';
            });

            // Edit modal
            document.getElementById('edit-cancel-btn').addEventListener('click', closeEditModal);
            document.getElementById('edit-save-btn').addEventListener('click', saveEdit);

            // Close modal on backdrop click
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeEditModal();
                }
            });

            // Disable send when empty
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            input.addEventListener('input', () => {
                sendBtn.disabled = !input.value.trim();
            });
            sendBtn.disabled = true;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const text = input.value.trim();

            if (!text) return;

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                await postChatMessage(teamId, {
                    text,
                    senderId: currentUser.uid,
                    senderName: currentUserProfile?.fullName || null,
                    senderEmail: currentUser.email,
                    senderPhotoUrl: currentUserProfile?.photoUrl || null
                });

                input.value = '';
                document.getElementById('send-error').classList.add('hidden');

                // Refresh to show new message
                messages = [];
                lastDoc = null;
                hasMoreMessages = true;
                await loadMessages();

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message. Please try again.');
            } finally {
                sendBtn.disabled = !input.value.trim();
                sendBtn.textContent = 'Send';
            }
        }

        // Edit functionality
        let editingMessageId = null;

        window.editMessage = function(messageId) {
            const msg = messages.find(m => m.id === messageId);
            if (!msg || msg.deleted) return;

            editingMessageId = messageId;
            document.getElementById('edit-textarea').value = msg.text;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-textarea').focus();
        };

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingMessageId = null;
        }

        async function saveEdit() {
            if (!editingMessageId) return;

            const newText = document.getElementById('edit-textarea').value.trim();
            if (!newText) {
                alert('Message cannot be empty');
                return;
            }

            const saveBtn = document.getElementById('edit-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                await editChatMessage(teamId, editingMessageId, newText);
                closeEditModal();

                // Refresh messages
                messages = [];
                lastDoc = null;
                hasMoreMessages = true;
                await loadMessages();

            } catch (error) {
                console.error('Error editing message:', error);
                alert('Failed to edit message. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        // Delete functionality
        window.deleteMessage = async function(messageId) {
            if (!confirm('Delete this message?')) return;

            try {
                await deleteChatMessage(teamId, messageId);

                // Refresh messages
                messages = [];
                lastDoc = null;
                hasMoreMessages = true;
                await loadMessages();

            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message. Please try again.');
            }
        };
    </script>
</body>

</html>
