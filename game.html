<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J13LHWFT3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3J13LHWFT3');
  </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo_small.png">
    <title>Match Report - ALL PLAYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900">
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-8 md:py-12">
        <!-- Team Navigation Banner (for logged-in team members) -->
        <div id="team-nav-banner" class="mb-6"></div>

        <!-- Back link fallback (hidden when banner is shown) -->
        <div id="back-link-container" class="mb-6">
            <a id="back-link" href="#"
                class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium transition group">
                <svg class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Team
            </a>
        </div>

        <div id="game-header"
            class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg p-8 md:p-12 mb-8 md:mb-12 text-center border border-gray-200">
            <div class="animate-pulse h-8 bg-gray-200 w-1/2 mx-auto mb-4 rounded"></div>
            <div class="animate-pulse h-12 bg-gray-200 w-1/4 mx-auto rounded"></div>
        </div>

        <!-- Game Summary Section -->
        <div class="mb-8 md:mb-10">
            <button id="summary-toggle" class="w-full text-left group">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Match Summary</h2>
                    </div>
                    <svg id="summary-chevron" class="w-6 h-6 text-gray-400 transition-transform duration-200"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            <div id="game-summary"
                class="bg-white shadow-lg rounded-2xl p-6 md:p-8 text-gray-700 leading-relaxed border border-gray-200 overflow-hidden transition-all duration-300">
                <p class="text-gray-500 italic">No summary available.</p>
            </div>
            <!-- Summary Admin Controls -->
            <div id="summary-admin" class="hidden mt-4 bg-white shadow-sm rounded-xl p-4 border border-gray-200">
                <div class="flex flex-wrap items-center gap-3">
                    <button id="summary-edit-btn"
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        Edit Summary
                    </button>
                    <span id="summary-edit-status" class="text-sm text-gray-500"></span>
                </div>

                <div id="summary-editor" class="hidden mt-4 space-y-3">
                    <textarea id="summary-textarea" class="w-full px-4 py-3 rounded-lg border border-gray-300 text-sm"
                        rows="6" placeholder="Write a game summary, key moments, standout performances..."></textarea>
                    <div class="flex flex-wrap gap-2">
                        <button id="summary-save-btn"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-semibold text-sm">
                            Save Summary
                        </button>
                        <button id="summary-cancel-btn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold text-sm">
                            Cancel
                        </button>
                        <button id="summary-generate-btn"
                            class="px-4 py-2 border border-primary-200 text-primary-700 rounded-lg hover:bg-primary-50 font-semibold text-sm">
                            Generate AI Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Score Sheet Photo -->
        <div id="stat-sheet-section" class="mb-8 md:mb-10 hidden">
            <div class="flex items-center gap-3 mb-4">
                <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Score Sheet</h2>
            </div>
            <div class="bg-white shadow-lg rounded-2xl p-4 border border-gray-200">
                <a id="stat-sheet-link" href="#" target="_blank" rel="noopener noreferrer"
                    class="block overflow-hidden rounded-xl border border-gray-100">
                    <img id="stat-sheet-img" src="" alt="Uploaded stat sheet" class="w-full h-auto object-contain">
                </a>
                <div id="stat-sheet-empty" class="hidden text-sm text-gray-500 text-center py-6">
                    No stat sheet uploaded yet.
                </div>
                <p class="mt-3 text-xs text-gray-500">Tap the image to view full size.</p>
            </div>
                <div id="stat-sheet-admin" class="mt-4 hidden bg-white shadow-sm rounded-xl p-4 border border-gray-200">
                    <div class="flex flex-wrap items-center gap-3">
                        <button id="stat-sheet-upload-btn"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                            Upload Score Sheet
                        </button>
                        <button id="stat-sheet-remove"
                            class="hidden px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50">
                            Remove Score Sheet
                        </button>
                        <span id="stat-sheet-status" class="text-sm text-gray-500"></span>
                    </div>
                <input id="stat-sheet-file-input" type="file" accept="image/*" class="hidden">
                <div id="stat-sheet-upload-preview" class="hidden mt-4 border border-gray-200 rounded-xl p-3">
                    <img id="stat-sheet-upload-img" src="" alt="Stat sheet preview" class="w-full h-auto object-contain rounded-lg">
                    <div class="mt-3 flex items-center gap-2">
                        <button id="stat-sheet-save"
                            class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Save</button>
                        <button id="stat-sheet-cancel"
                            class="px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Stats Section -->
        <div class="mb-8 md:mb-10">
            <div class="flex items-center gap-3 mb-4">
                <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Player Performance</h2>
            </div>
            <div class="bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead
                            class="bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 uppercase text-xs font-semibold">
                            <tr id="stats-header-row">
                                <th class="px-4 py-4 text-left">#</th>
                                <th class="px-4 py-4 text-left">Player</th>
                                <!-- Dynamic Stat Columns -->
                            </tr>
                        </thead>
                        <tbody id="stats-body" class="divide-y divide-gray-100">
                            <!-- Player Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Game Log and Opponent Stats Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
            <div>
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Play-by-Play</h2>
                </div>
                <div id="game-log"
                    class="bg-white shadow-lg rounded-2xl p-6 border border-gray-200 h-[500px] overflow-y-auto">
                    <div class="text-gray-500 text-sm">No events logged.</div>
                </div>
            </div>
            <div>
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Opponent Stats</h2>
                </div>
                <div
                    class="bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200 h-[500px] overflow-y-auto">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead
                                class="bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 uppercase text-xs font-semibold sticky top-0">
                                <tr id="opponent-stats-header-row">
                                    <th class="px-4 py-4 text-left">#</th>
                                    <th class="px-4 py-4 text-left">Player</th>
                                    <!-- Dynamic Stat Columns -->
                                </tr>
                            </thead>
                            <tbody id="opponent-stats-body" class="divide-y divide-gray-100">
                                <!-- Opponent Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Playing Time Insights Section (Beta Basketball) -->
        <div id="playing-time-insights" class="mb-8 md:mb-10 hidden">
            <button id="playing-time-toggle" class="w-full text-left group">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="h-1 w-8 bg-gradient-to-r from-primary-500 to-primary-700 rounded-full"></div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Playing Time Distribution</h2>
                    </div>
                    <svg id="playing-time-chevron" class="w-6 h-6 text-gray-400 transition-transform duration-200"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            <div id="playing-time-content"
                class="bg-white shadow-lg rounded-2xl border border-gray-200 overflow-hidden transition-all duration-300"
                style="max-height: 0px;">
                <div class="p-6 md:p-8">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <div>
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Rotation</div>
                            <p class="text-sm text-gray-500 mt-1">Minutes played during this game.</p>
                        </div>
                        <div id="playing-time-meta" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="playing-time-body"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script type="module">
        import { getTeam, getGame, getPlayers, getUnreadChatCounts, getUserProfile, updateGame, uploadStatSheetPhoto } from './js/db.js';
        import { renderHeader, renderFooter, getUrlParams, formatDate, formatShortDate, escapeHtml, shareOrCopy } from './js/utils.js?v=8';
        import { checkAuth } from './js/auth.js?v=9';
        import { collection, getDocs, query, orderBy } from "./js/firebase.js?v=9";
        import { db } from './js/firebase.js?v=9';
        import { renderTeamAdminBanner, getTeamAccessInfo } from './js/team-admin-banner.js';

        let currentUser = null;
        let canManageStatSheet = false;
        let canEditSummary = false;
        let authResolved = false;
        let gameLoaded = false;

        const authTimeout = setTimeout(() => {
            if (authResolved || gameLoaded) return;
            renderHeader(document.getElementById('header-container'), null);
            loadGame();
        }, 3000);

        checkAuth((user) => {
            authResolved = true;
            clearTimeout(authTimeout);
            // Allow viewing without login - user can be null
            currentUser = user;
            renderHeader(document.getElementById('header-container'), user);
            loadGame();
        });

        renderFooter(document.getElementById('footer-container'));

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Summary toggle functionality
        let summaryExpanded = true;
        const summaryToggle = document.getElementById('summary-toggle');
        const summaryContent = document.getElementById('game-summary');
        const summaryChevron = document.getElementById('summary-chevron');

        summaryToggle.addEventListener('click', () => {
            summaryExpanded = !summaryExpanded;
            if (summaryExpanded) {
                summaryContent.style.maxHeight = summaryContent.scrollHeight + 'px';
                summaryChevron.style.transform = 'rotate(0deg)';
            } else {
                summaryContent.style.maxHeight = '0px';
                summaryChevron.style.transform = 'rotate(-90deg)';
            }
        });

        // Playing time toggle functionality
        let playingTimeExpanded = false;
        const playingTimeToggle = document.getElementById('playing-time-toggle');
        const playingTimeContent = document.getElementById('playing-time-content');
        const playingTimeChevron = document.getElementById('playing-time-chevron');

        playingTimeToggle.addEventListener('click', () => {
            playingTimeExpanded = !playingTimeExpanded;
            if (playingTimeExpanded) {
                playingTimeContent.style.maxHeight = playingTimeContent.scrollHeight + 'px';
                playingTimeChevron.style.transform = 'rotate(0deg)';
            } else {
                playingTimeContent.style.maxHeight = '0px';
                playingTimeChevron.style.transform = 'rotate(-90deg)';
            }
        });

        function setupStatSheetControls(teamId, gameId, game) {
            const section = document.getElementById('stat-sheet-section');
            const link = document.getElementById('stat-sheet-link');
            const img = document.getElementById('stat-sheet-img');
            const empty = document.getElementById('stat-sheet-empty');
            const admin = document.getElementById('stat-sheet-admin');
            const uploadBtn = document.getElementById('stat-sheet-upload-btn');
            const fileInput = document.getElementById('stat-sheet-file-input');
            const preview = document.getElementById('stat-sheet-upload-preview');
            const previewImg = document.getElementById('stat-sheet-upload-img');
            const saveBtn = document.getElementById('stat-sheet-save');
            const cancelBtn = document.getElementById('stat-sheet-cancel');
            const status = document.getElementById('stat-sheet-status');

            if (!section || !link || !img || !empty || !admin) return;

            if (game.statSheetPhotoUrl) {
                section.classList.remove('hidden');
                img.classList.remove('hidden');
                empty.classList.add('hidden');
                img.src = game.statSheetPhotoUrl;
                link.href = game.statSheetPhotoUrl;
            } else if (canManageStatSheet) {
                section.classList.remove('hidden');
                img.classList.add('hidden');
                empty.classList.remove('hidden');
                link.removeAttribute('href');
            } else {
                section.classList.add('hidden');
            }

            if (!canManageStatSheet) {
                admin.classList.add('hidden');
                return;
            }

            admin.classList.remove('hidden');

            uploadBtn?.addEventListener('click', () => {
                if (status) status.textContent = '';
                if (!fileInput) {
                    if (status) status.textContent = 'Upload input unavailable. Please refresh.';
                    return;
                }
                if (typeof fileInput.showPicker === 'function') {
                    fileInput.showPicker();
                } else {
                    fileInput.click();
                }
            });

            fileInput?.addEventListener('change', () => {
                const file = fileInput.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImg.src = event.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });

            cancelBtn?.addEventListener('click', () => {
                fileInput.value = '';
                preview.classList.add('hidden');
                status.textContent = '';
            });

            saveBtn?.addEventListener('click', async () => {
                const file = fileInput.files?.[0];
                if (!file) {
                    status.textContent = 'Choose an image first.';
                    return;
                }
                saveBtn.disabled = true;
                uploadBtn.disabled = true;
                status.textContent = 'Uploading...';
                try {
                    const url = await uploadStatSheetPhoto(file);
                    await updateGame(teamId, gameId, { statSheetPhotoUrl: url });
                    game.statSheetPhotoUrl = url;
                    img.src = url;
                    img.classList.remove('hidden');
                    link.href = url;
                    empty.classList.add('hidden');
                    preview.classList.add('hidden');
                    fileInput.value = '';
                    status.textContent = 'Saved.';
                } catch (error) {
                    console.error('Stat sheet upload failed:', error);
                    status.textContent = `Error: ${error.message}`;
                } finally {
                    saveBtn.disabled = false;
                    uploadBtn.disabled = false;
                }
            });

            const removeBtn = document.getElementById('stat-sheet-remove');
            if (game.statSheetPhotoUrl) {
                uploadBtn.classList.add('hidden');
                if (removeBtn) removeBtn.classList.remove('hidden');
            } else {
                uploadBtn.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.add('hidden');
            }

            removeBtn?.addEventListener('click', async () => {
                if (!game.statSheetPhotoUrl) return;
                const confirmRemove = confirm('Remove the stat sheet image from this game?');
                if (!confirmRemove) return;
                removeBtn.disabled = true;
                status.textContent = 'Removing...';
                try {
                    await updateGame(teamId, gameId, { statSheetPhotoUrl: null });
                    game.statSheetPhotoUrl = null;
                    img.classList.add('hidden');
                    link.removeAttribute('href');
                    empty.classList.remove('hidden');
                    preview.classList.add('hidden');
                    fileInput.value = '';
                    status.textContent = 'Removed.';
                    uploadBtn.classList.remove('hidden');
                    removeBtn.classList.add('hidden');
                } catch (error) {
                    console.error('Stat sheet remove failed:', error);
                    status.textContent = `Error: ${error.message}`;
                } finally {
                    removeBtn.disabled = false;
                }
            });
        }

        async function setupSummaryControls(teamId, gameId, game, team, players, statsMap, statKeys, statLabels) {
            const admin = document.getElementById('summary-admin');
            const editBtn = document.getElementById('summary-edit-btn');
            const status = document.getElementById('summary-edit-status');
            const editor = document.getElementById('summary-editor');
            const textarea = document.getElementById('summary-textarea');
            const saveBtn = document.getElementById('summary-save-btn');
            const cancelBtn = document.getElementById('summary-cancel-btn');
            const generateBtn = document.getElementById('summary-generate-btn');
            const summaryDiv = document.getElementById('game-summary');

            if (!admin || !editBtn || !status || !editor || !textarea || !saveBtn || !cancelBtn || !generateBtn || !summaryDiv) {
                return;
            }

            if (!canEditSummary) {
                admin.classList.add('hidden');
                return;
            }

            admin.classList.remove('hidden');

            let generatedSummary = '';

            const openEditor = (auto = false) => {
                editor.classList.remove('hidden');
                editBtn.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                if (auto && !game.summary) {
                    textarea.value = '';
                }
            };

            const closeEditor = () => {
                editor.classList.add('hidden');
                editBtn.classList.remove('hidden');
                summaryDiv.classList.remove('hidden');
                textarea.value = game.summary || '';
                status.textContent = '';
            };

            editBtn.addEventListener('click', () => {
                textarea.value = game.summary || '';
                openEditor(false);
            });

            if (!game.summary) {
                openEditor(true);
            }

            generateBtn.addEventListener('click', async () => {
                generateBtn.disabled = true;
                status.textContent = 'Generating AI summary‚Ä¶';

                try {
                    const { getAI, getGenerativeModel, GoogleAIBackend } = await import('./js/vendor/firebase-ai.js');
                    const { getApp } = await import('./js/vendor/firebase-app.js');

                    const pointsKey = statKeys.find(key => ['pts', 'points', 'point'].includes(key)) || 'points';
                    let context = `Game: ${team.name} vs ${game.opponent}\n`;
                    context += `Final Score: ${game.homeScore || 0} - ${game.awayScore || 0}\n`;
                    context += `Date: ${game.date ? new Date(game.date.seconds * 1000).toLocaleDateString() : new Date().toLocaleDateString()}\n`;
                    context += `Sport: ${team.sport || 'Basketball'}\n\n`;

                    context += `${team.name.toUpperCase()} PLAYERS:\n`;
                    players.forEach(player => {
                        const pStats = statsMap[player.id] || {};
                        const points = pStats[pointsKey] || 0;
                        const fouls = pStats.fouls || 0;
                        context += `#${player.number || '-'} ${player.name}: ${pointsKey.toUpperCase()}:${points}, FOULS:${fouls}\n`;
                    });

                    if (game.opponentStats && Object.keys(game.opponentStats).length > 0) {
                        context += `\n${(game.opponent || 'OPPONENT').toUpperCase()} PLAYERS:\n`;
                        Object.values(game.opponentStats).forEach(opp => {
                            const { name, number, notes, ...statValues } = opp;
                            const points = statValues[pointsKey] || statValues.pts || statValues.points || 0;
                            const fouls = statValues.fouls || 0;
                            if (name || points > 0 || fouls > 0) {
                                context += `#${number || '-'} ${name || 'Player'}: ${pointsKey.toUpperCase()}:${points}, FOULS:${fouls}\n`;
                            }
                        });
                    }

                    const prompt = `You are a sports reporter writing a match report for a youth sports game.
Write a comprehensive but concise game summary in paragraph form (2-5 paragraphs).
Make it engaging and professional, as if it would appear in a sports publication. Focus on the narrative, not just listing stats.

NOTE: This summary is based on final stats from a score sheet, without play-by-play details.

GAME DATA:
${context}

Write the match report now:`;

                    const firebaseApp = getApp();
                    const ai = getAI(firebaseApp, { backend: new GoogleAIBackend() });
                    const model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
                    const result = await model.generateContent(prompt);
                    generatedSummary = result.response.text();
                    textarea.value = generatedSummary;
                    status.textContent = 'Summary added to text area. You can edit it before saving.';
                } catch (error) {
                    console.error('AI summary error:', error);
                    status.textContent = `Error: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                }
            });

            saveBtn.addEventListener('click', async () => {
                const summaryText = textarea.value.trim();
                if (!summaryText && !generatedSummary) {
                    status.textContent = 'Add a summary or generate one first.';
                    return;
                }

                saveBtn.disabled = true;
                status.textContent = 'Saving summary‚Ä¶';
                try {
                    const finalSummary = summaryText || generatedSummary;
                    await updateGame(teamId, gameId, { summary: finalSummary });
                    game.summary = finalSummary;
                    summaryDiv.innerHTML = `<div class="prose prose-gray max-w-none">${escapeHtml(finalSummary).replace(/\n/g, '<br>')}</div>`;
                    setTimeout(() => {
                        summaryDiv.style.maxHeight = summaryDiv.scrollHeight + 'px';
                    }, 100);
                    closeEditor();
                } catch (error) {
                    console.error('Error saving summary:', error);
                    status.textContent = `Error: ${error.message}`;
                    saveBtn.disabled = false;
                }
            });

            cancelBtn.addEventListener('click', closeEditor);
        }

        async function loadGame() {
            if (gameLoaded) return;
            gameLoaded = true;
            const { teamId, gameId } = getUrlParams();
            if (!teamId || !gameId) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('back-link').href = `team.html#teamId=${teamId}`;

            try {
                const [team, game, players] = await Promise.all([
                    getTeam(teamId),
                    getGame(teamId, gameId),
                    getPlayers(teamId)
                ]);

                if (!game) {
                    document.querySelector('main').innerHTML = '<div class="text-center py-12 text-red-500">Game not found</div>';
                    return;
                }

                // Render team navigation banner if user has access
                if (currentUser) {
                    // Enrich user profile if needed
                    try {
                        const profile = await getUserProfile(currentUser.uid);
                        if (profile) {
                            if (profile.isAdmin) currentUser.isAdmin = true;
                            if (profile.parentOf) currentUser.parentOf = profile.parentOf;
                            if (profile.coachOf) currentUser.coachOf = profile.coachOf;
                        }
                    } catch (e) {
                        console.error('Error loading user profile for banner:', e);
                    }

                    const accessInfo = getTeamAccessInfo(currentUser, { ...team, id: teamId });
                    if (accessInfo.hasAccess) {
                        canManageStatSheet = accessInfo.accessLevel === 'full';
                        canEditSummary = accessInfo.accessLevel === 'full';
                        // Fetch unread count for chat badge
                        let unreadCount = 0;
                        try {
                            const counts = await getUnreadChatCounts(currentUser.uid, [teamId]);
                            unreadCount = counts[teamId] || 0;
                        } catch (e) {
                            console.error('Error fetching unread counts:', e);
                        }

                        renderTeamAdminBanner(
                            document.getElementById('team-nav-banner'),
                            {
                                team,
                                teamId,
                                active: '', // No highlight on game page
                                unreadCount,
                                accessLevel: accessInfo.accessLevel,
                                exitUrl: accessInfo.exitUrl
                            }
                        );
                        // Hide fallback back link when banner is shown
                        const backLinkContainer = document.getElementById('back-link-container');
                        if (backLinkContainer) backLinkContainer.classList.add('hidden');
                    }
                }

                // Practices don't have game reports - redirect to team page
                if (game.type === 'practice') {
                    alert('Practice events do not have game reports.');
                    window.location.href = `team.html#teamId=${teamId}`;
                    return;
                }

                // Render Header
                const isWin = (game.homeScore || 0) > (game.awayScore || 0);
                const isLoss = (game.homeScore || 0) < (game.awayScore || 0);
                const isTie = (game.homeScore || 0) === (game.awayScore || 0) && game.status === 'completed';

                document.getElementById('game-header').innerHTML = `
                    <div class="inline-flex items-center gap-2 mb-4">
                        <div class="px-4 py-1.5 rounded-full text-xs font-semibold uppercase tracking-wider ${isWin ? 'bg-green-100 text-green-700' :
                        isLoss ? 'bg-red-100 text-red-700' :
                            isTie ? 'bg-gray-100 text-gray-700' :
                                'bg-primary-100 text-primary-700'
                    }">
                            ${isWin ? 'Victory' : isLoss ? 'Defeat' : isTie ? 'Tie' : 'Match Report'}
                        </div>
                        <div class="text-gray-500 font-medium text-sm">${formatDate(game.date)}</div>
                    </div>
                    <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 md:mb-8 text-gray-900">
                        <span class="inline-flex items-center gap-2">
                            ${team.photoUrl ? `<img src="${escapeHtml(team.photoUrl)}" alt="" class="w-10 h-10 rounded-full object-cover border border-gray-200">` : ''}
                            ${escapeHtml(team.name)}
                        </span>
                        <span class="text-gray-400 mx-2 md:mx-3">vs</span>
                        <span class="inline-flex items-center gap-2">
                            ${game.opponentTeamPhoto ? `<img src="${escapeHtml(game.opponentTeamPhoto)}" alt="" class="w-10 h-10 rounded-full object-cover border border-gray-200">` : ''}
                            ${escapeHtml(game.opponent)}
                        </span>
                    </h1>
                    <div class="flex justify-center items-center gap-6 md:gap-8 mb-6">
                        <div class="text-center">
                            <div class="text-sm text-gray-500 mb-2 font-medium">${escapeHtml(team.name)}</div>
                            <div class="text-5xl md:text-6xl lg:text-7xl font-mono font-bold ${isWin ? 'text-green-600' : 'text-primary-600'
                    }">${game.homeScore || 0}</div>
                        </div>
                        <div class="text-3xl md:text-4xl text-gray-300 font-light">-</div>
                        <div class="text-center">
                            <div class="text-sm text-gray-500 mb-2 font-medium flex items-center justify-center gap-2">
                                ${game.opponentTeamPhoto ? `<img src="${escapeHtml(game.opponentTeamPhoto)}" alt="" class="w-6 h-6 rounded-full object-cover border border-gray-200">` : ''}
                                <span>${escapeHtml(game.opponent)}</span>
                            </div>
                            <div class="text-5xl md:text-6xl lg:text-7xl font-mono font-bold ${isLoss ? 'text-red-600' : 'text-gray-600'
                    }">${game.awayScore || 0}</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3 mb-4">
                    ${game.liveStatus === 'completed' ? `
                        <a href="live-game.html?teamId=${teamId}&gameId=${gameId}&replay=true"
                           class="inline-flex items-center gap-2 bg-teal-500 text-white px-5 py-2 rounded-full font-semibold shadow hover:bg-teal-600 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Watch Replay
                        </a>
                    ` : ''}
                    ${game.liveStatus === 'live' ? `
                        <a href="live-game.html?teamId=${teamId}&gameId=${gameId}"
                           class="inline-flex items-center gap-2 bg-red-500 text-white px-5 py-2 rounded-full font-semibold shadow hover:bg-red-600 transition">
                            <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                            Live Now
                        </a>
                    ` : ''}
                    ${game.status !== 'completed' && game.liveStatus === 'live' ? `
                        <a href="live-game.html?teamId=${teamId}&gameId=${gameId}"
                           class="inline-flex items-center gap-2 bg-slate-800 text-white px-5 py-2 rounded-full font-semibold shadow hover:bg-slate-900 transition">
                            <span class="text-xs">üëÅÔ∏è</span>
                            View Live
                        </a>
                    ` : ''}
                        <button id="share-report-btn"
                            class="inline-flex items-center gap-2 bg-white text-slate-700 px-5 py-2 rounded-full font-semibold shadow border border-gray-200 hover:bg-gray-50 transition">
                            <span class="text-xs">üîó</span>
                            Share Report
                        </button>
                    </div>
                    ${game.location ? `
                        <div class="flex items-center justify-center gap-2 text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>${escapeHtml(game.location)}</span>
                        </div>
                    ` : ''}
                `;

                const shareBtn = document.getElementById('share-report-btn');
                if (shareBtn) {
                    shareBtn.addEventListener('click', async () => {
                        const teamName = team?.name || 'Team';
                        const opponent = game?.opponent || 'Opponent';
                        const dateLabel = formatShortDate(game?.date);
                        const url = `${window.location.origin}/game.html#teamId=${teamId}&gameId=${gameId}`;
                        const shareText = `Game report: ${teamName} vs ${opponent}${dateLabel ? ` ‚Äî ${dateLabel}` : ''}\n${url}`;
                        const result = await shareOrCopy({
                            title: 'Game report',
                            text: shareText.split('\n')[0],
                            url,
                            clipboardText: shareText
                        });
                        if (result.status === 'shared') showToast('Share sheet opened!');
                        if (result.status === 'copied') showToast('Share text copied!');
                        if (result.status === 'failed') showToast('Failed to share.');
                    });
                }

                // Render Summary
                const summaryDiv = document.getElementById('game-summary');
                if (game.summary) {
                    summaryDiv.innerHTML = `<div class="prose prose-gray max-w-none">${escapeHtml(game.summary).replace(/\n/g, '<br>')}</div>`;
                } else {
                    summaryDiv.innerHTML = '<p class="text-gray-500 italic">No summary available.</p>';
                }
                // Set initial max-height for collapse animation
                setTimeout(() => {
                    summaryDiv.style.maxHeight = summaryDiv.scrollHeight + 'px';
                }, 100);

                setupStatSheetControls(teamId, gameId, game);

                // Fetch Aggregated Stats
                // We need to fetch from subcollection: teams/{teamId}/games/{gameId}/aggregatedStats
                const statsSnapshot = await getDocs(collection(db, `teams/${teamId}/games/${gameId}/aggregatedStats`));
                const statsMap = {};
                const timeMap = {};
                statsSnapshot.forEach(doc => {
                    const data = doc.data();
                    statsMap[doc.id] = data.stats;
                    timeMap[doc.id] = data.timeMs || 0;
                });

                // Fetch the config used for this game
                let statKeys = [];
                let statLabels = {};

                if (game.statTrackerConfigId) {
                    try {
                        const configDoc = await getDocs(query(collection(db, `teams/${teamId}/statTrackerConfigs`)));
                        const configs = configDoc.docs.map(d => ({ id: d.id, ...d.data() }));
                        const config = configs.find(c => c.id === game.statTrackerConfigId);

                        if (config && config.columns) {
                            // First, collect all actual field names from the stats data
                            const actualFields = new Set();
                            Object.values(statsMap).forEach(stats => {
                                Object.keys(stats).forEach(k => actualFields.add(k.toLowerCase()));
                            });

                            // Map config columns to actual field names in the data
                            // Try variations: PTS -> points, pts, etc.
                            config.columns.forEach(col => {
                                const normalized = col.toLowerCase();
                                let fieldName = normalized;

                                // Try to find matching field in actual data
                                // Check for common variations
                                const variations = [
                                    normalized,                                    // pts
                                ];
                                if (!normalized.endsWith('s')) {
                                    variations.push(normalized + 's');             // pt -> pts
                                } else {
                                    variations.push(normalized.slice(0, -1));      // pts -> pt
                                }

                                // Special mappings
                                if (normalized === 'pts' || normalized === 'points') {
                                    variations.push('pts', 'points', 'pt');
                                }
                                if (normalized === 'rebs' || normalized === 'reb') {
                                    variations.push('rebs', 'reb', 'rebounds');
                                }
                                if (normalized === 'ast' || normalized === 'assists') {
                                    variations.push('ast', 'assists', 'assist');
                                }

                                // Find first matching variation in actual data
                                for (const variant of variations) {
                                    if (actualFields.has(variant)) {
                                        fieldName = variant;
                                        break;
                                    }
                                }

                                statKeys.push(fieldName);
                                statLabels[fieldName] = col;
                            });
                        }
                    } catch (err) {
                        console.error('Error fetching config:', err);
                    }
                }

                // Fallback: if no config, collect all unique keys from statsMap
                if (statKeys.length === 0) {
                    const allKeys = new Set();
                    Object.values(statsMap).forEach(stats => {
                        Object.keys(stats).forEach(k => allKeys.add(k));
                    });
                    statKeys = Array.from(allKeys).sort();
                    // Use uppercase for labels
                    statKeys.forEach(key => {
                        statLabels[key] = key.toUpperCase();
                    });
                }

                // Always include fouls if present in the data
                if (!statKeys.includes('fouls')) {
                    // Check if fouls exist in any player's stats
                    const hasFouls = Object.values(statsMap).some(stats => stats.fouls !== undefined);
                    if (hasFouls) {
                        statKeys.push('fouls');
                        statLabels['fouls'] = 'FOULS';
                    }
                }

                // Setup summary controls
                setupSummaryControls(teamId, gameId, game, team, players, statsMap, statKeys, statLabels);

                // Check if we have any playing time data
                const hasPlayingTime = Object.values(timeMap).some(t => t > 0);

                // Render Table Header
                const headerRow = document.getElementById('stats-header-row');
                statKeys.forEach(key => {
                    const th = document.createElement('th');
                    th.className = "px-4 py-4 text-center";
                    th.textContent = statLabels[key] || key.toUpperCase();
                    headerRow.appendChild(th);
                });

                // Add Minutes column if we have playing time data
                if (hasPlayingTime) {
                    const minTh = document.createElement('th');
                    minTh.className = "px-4 py-4 text-center";
                    minTh.textContent = "MIN";
                    headerRow.appendChild(minTh);
                }

                // Helper function to format milliseconds to MM:SS
                function formatMMSS(ms) {
                    const totalSeconds = Math.max(0, Math.floor((ms || 0) / 1000));
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                // Render Table Body
                const tbody = document.getElementById('stats-body');
                if (players.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="100%" class="p-8 text-center"><div class="text-gray-400 text-sm">No players found.</div></td></tr>';
                } else {
                    tbody.innerHTML = players.map(p => {
                        const pStats = statsMap[p.id] || {};
                        const pTime = timeMap[p.id] || 0;
                        const statCells = statKeys.map(key => `
                            <td class="px-4 py-4 text-center font-mono text-gray-700 font-semibold">${pStats[key] || 0}</td>
                        `).join('');
                        const minutesCell = hasPlayingTime ? `
                            <td class="px-4 py-4 text-center font-mono text-gray-700 font-semibold">${formatMMSS(pTime)}</td>
                        ` : '';
                        return `
                            <tr class="bg-white hover:bg-gray-50 transition">
                                    <td class="px-4 py-4 font-mono text-gray-500 font-semibold">${escapeHtml(p.number || '-')}</td>
                                    <td class="px-4 py-4 font-medium">
                                        <a href="player.html#teamId=${teamId}&gameId=${gameId}&playerId=${p.id}"
                                           class="flex items-center gap-3 text-primary-600 hover:text-primary-700 hover:underline transition">
                                            <span class="inline-flex h-10 w-10 rounded-full bg-gray-100 overflow-hidden border border-gray-200">
                                                ${p.photoUrl ? `<img src="${escapeHtml(p.photoUrl)}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">` : `
                                                    <svg class="w-full h-full text-gray-400 p-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1119 12.999M15 21v-2a3 3 0 00-3-3H6a3 3 0 00-3 3v2"></path>
                                                    </svg>
                                                `}
                                            </span>
                                            <span>${escapeHtml(p.name)}</span>
                                        </a>
                                    </td>
                                ${statCells}
                                ${minutesCell}
                            </tr>
                        `;
                    }).join('');
                }

                // Render Playing Time Insights
                if (hasPlayingTime) {
                    const playingTimeSection = document.getElementById('playing-time-insights');
                    playingTimeSection.classList.remove('hidden');

                    // Set initial collapsed state
                    playingTimeChevron.style.transform = 'rotate(-90deg)';

                    const roster = players.map(p => ({
                        id: p.id,
                        name: p.name || '',
                        number: p.number || '-',
                        timeMs: timeMap[p.id] || 0,
                        photoUrl: p.photoUrl
                    }));

                    const maxTime = Math.max(...roster.map(p => p.timeMs), 1);
                    const totalTime = roster.reduce((sum, p) => sum + p.timeMs, 0);
                    const playedCount = roster.filter(p => p.timeMs > 0).length;
                    const above40 = roster.filter(p => (p.timeMs / maxTime) >= 0.4).length;
                    const balancePct = roster.length ? Math.round((above40 / roster.length) * 100) : 0;

                    const meta = document.getElementById('playing-time-meta');
                    meta.innerHTML = `
                        <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-primary-50 border border-primary-200 text-primary-800 rounded-lg text-sm font-semibold">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            ${playedCount} played
                        </span>
                        <span class="inline-flex items-center gap-2 px-3 py-1.5 ${balancePct >= 60 ? 'bg-green-50 border-green-200 text-green-800' : balancePct >= 40 ? 'bg-yellow-50 border-yellow-200 text-yellow-800' : 'bg-red-50 border-red-200 text-red-800'} border rounded-lg text-sm font-semibold">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            ${balancePct}% balanced
                        </span>
                    `;

                    const sorted = [...roster].sort((a, b) => b.timeMs - a.timeMs);
                    const body = document.getElementById('playing-time-body');

                    body.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                                    Players
                                </h3>
                                <div class="space-y-3">
                                    ${sorted.map(p => {
                                        const pct = Math.round((p.timeMs / maxTime) * 100);
                                        const href = `player.html#teamId=${teamId}&gameId=${gameId}&playerId=${p.id}`;
                                        return `
                                            <a href="${href}" class="block group/item">
                                                <div class="flex items-center justify-between gap-3 mb-1.5">
                                                    <div class="flex items-center gap-3 min-w-0 flex-1">
                                                        <span class="inline-flex h-8 w-8 rounded-full bg-gray-100 overflow-hidden border border-gray-200 flex-shrink-0">
                                                            ${p.photoUrl ? `<img src="${escapeHtml(p.photoUrl)}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">` : `
                                                                <svg class="w-full h-full text-gray-400 p-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1119 12.999M15 21v-2a3 3 0 00-3-3H6a3 3 0 00-3 3v2"></path>
                                                                </svg>
                                                            `}
                                                        </span>
                                                        <div class="min-w-0">
                                                            <div class="text-sm font-semibold text-gray-900 truncate group-hover/item:text-primary-700 transition">#${escapeHtml(p.number)} ${escapeHtml(p.name)}</div>
                                                        </div>
                                                    </div>
                                                    <div class="text-sm font-mono font-semibold text-gray-700">${formatMMSS(p.timeMs)}</div>
                                                </div>
                                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="h-full rounded-full bg-gradient-to-r from-primary-500 to-primary-700 transition-all" style="width:${pct}%"></div>
                                                </div>
                                            </a>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="lg:col-span-1">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                                    Summary
                                </h3>
                                <div class="space-y-3 text-sm text-gray-700">
                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                                        <span class="font-semibold text-gray-600">Longest time</span>
                                        <span class="font-mono font-bold text-gray-900">${formatMMSS(sorted[0]?.timeMs || 0)}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                                        <span class="font-semibold text-gray-600">40%+ of max</span>
                                        <span class="font-mono font-bold text-gray-900">${above40} / ${roster.length}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                                        <span class="font-semibold text-gray-600">Players used</span>
                                        <span class="font-mono font-bold text-gray-900">${playedCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Render Opponent Stats
                if (game.opponentStats && Object.keys(game.opponentStats).length > 0) {
                    const opponentHeaderRow = document.getElementById('opponent-stats-header-row');
                    const opponentTbody = document.getElementById('opponent-stats-body');

                    // Get stat keys from opponent stats
                    const opponentStatKeys = new Set();
                    const metadataKeys = new Set(['name', 'number', 'notes']);
                    Object.values(game.opponentStats).forEach(stats => {
                        Object.keys(stats).forEach(k => {
                            if (!metadataKeys.has(k)) {
                                opponentStatKeys.add(k);
                            }
                        });
                    });
                    let oppKeys = Array.from(opponentStatKeys).sort();

                    // Move fouls to the end if present (for better visual organization)
                    const foulIndex = oppKeys.indexOf('fouls');
                    if (foulIndex > -1) {
                        oppKeys.splice(foulIndex, 1);
                        oppKeys.push('fouls');
                    }

                    // Render header
                    oppKeys.forEach(key => {
                        const th = document.createElement('th');
                        th.className = "px-4 py-4 text-center";
                        th.textContent = key.toUpperCase();
                        opponentHeaderRow.appendChild(th);
                    });

                    // Render rows
                    const opponentPlayers = Object.entries(game.opponentStats).map(([id, stats]) => {
                        const { name, number, notes, photoUrl, ...statValues } = stats;
                        return {
                            id,
                            number: number || '-',
                            name: name || 'Opponent Player',
                            photoUrl: photoUrl || '',
                            stats: statValues
                        };
                    });

                    opponentTbody.innerHTML = opponentPlayers.map(p => {
                        const statCells = oppKeys.map(key => `
                            <td class="px-4 py-4 text-center font-mono text-gray-700 font-semibold">${p.stats[key] || 0}</td>
                        `).join('');
                        return `
                            <tr class="bg-white hover:bg-gray-50 transition">
                                <td class="px-4 py-4 font-mono text-gray-500 font-semibold">${escapeHtml(p.number)}</td>
                                <td class="px-4 py-4 font-medium text-gray-900">
                                    <div class="flex items-center gap-2">
                                        ${p.photoUrl ? `<img src="${escapeHtml(p.photoUrl)}" alt="" class="w-6 h-6 rounded-full object-cover">` : `<div class="w-6 h-6 rounded-full bg-gray-100 text-gray-600 text-xs flex items-center justify-center font-semibold">${escapeHtml((p.name || 'O')[0])}</div>`}
                                        <span>${escapeHtml(p.name)}</span>
                                    </div>
                                </td>
                                ${statCells}
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('opponent-stats-body').innerHTML =
                        '<tr><td colspan="100%" class="p-8 text-center"><div class="text-gray-400 text-sm">No opponent stats available.</div></td></tr>';
                }

                // Fetch and render game log (events)
                const eventsQuery = query(collection(db, `teams/${teamId}/games/${gameId}/events`), orderBy('timestamp', 'asc'));
                const eventsSnapshot = await getDocs(eventsQuery);
                const events = eventsSnapshot.docs.map(doc => doc.data());

                if (events.length > 0) {
                    const gameLogDiv = document.getElementById('game-log');
                    gameLogDiv.innerHTML = `
                        <div class="space-y-2">
                            ${events.map((event, index) => {
                        const timestamp = event.timestamp ? new Date(event.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                        const period = event.period || 'Q1';
                        const gameTime = event.gameTime || '';
                        return `
                                    <div class="flex items-start gap-3 py-3 px-3 border-l-4 border-primary-500 bg-gray-50 rounded-r hover:bg-gray-100 transition">
                                        <div class="flex-shrink-0 pt-0.5">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold bg-primary-600 text-white shadow-sm">${escapeHtml(period)}</span>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <div class="text-sm text-gray-900 font-medium leading-relaxed">${escapeHtml(event.text || event.message || 'Event logged')}</div>
                                            <div class="flex items-center gap-3 mt-1">
                                                ${gameTime ? `<span class="text-xs text-gray-600 font-mono font-semibold">${escapeHtml(gameTime)}</span>` : ''}
                                                ${timestamp ? `<span class="text-xs text-gray-500">${timestamp}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('game-log').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center py-12">
                            <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-400 font-medium">No events logged</p>
                            <p class="text-gray-400 text-sm mt-1">Play-by-play will appear here during the game</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error(error);
                const main = document.querySelector('main');
                if (main) {
                    const needsAuth = error?.code === 'permission-denied';
                    main.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            ${needsAuth ? 'Please sign in to view this game.' : 'Error loading game.'}
                        </div>
                    `;
                }
            }
        }
    </script>
</body>

</html>
