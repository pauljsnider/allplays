<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo_small.png">
    <title>Edit Schedule - ALL PLAYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-900">
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-8">
        <div class="mb-4">
            <a href="dashboard.html" class="text-indigo-600 hover:underline">&larr; Back to Dashboard</a>
        </div>

        <!-- Calendar Management -->
        <div class="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-indigo-900">üìÖ Calendar Links</h3>
                <button id="add-calendar-btn"
                    class="text-sm bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">
                    + Add Calendar
                </button>
            </div>
            <div id="calendar-list" class="space-y-2">
                <!-- Calendar URLs will be listed here -->
            </div>
            <div id="add-calendar-form" class="hidden mt-3 p-3 bg-white rounded border border-indigo-200">
                <input type="url" id="calendar-url-input" placeholder="https://example.com/calendar.ics"
                    class="w-full px-3 py-2 border border-gray-300 rounded mb-2 text-sm">
                <div class="flex gap-2">
                    <button id="save-calendar-btn"
                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Save</button>
                    <button id="cancel-calendar-btn"
                        class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Add Game Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-8">
                    <h2 class="text-xl font-bold mb-4">Add Game</h2>
                    <form id="add-game-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date & Time</label>
                            <input type="datetime-local" id="gameDate" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Opponent</label>
                            <input type="text" id="opponent" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location</label>
                            <input type="text" id="location"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stat Config</label>
                            <select id="statConfig"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                                <option value="">Default (None)</option>
                                <!-- Configs loaded here -->
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Create configs in <a href="#" id="config-link"
                                    class="text-indigo-600 hover:underline">Edit Configs</a></p>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" id="submit-game-btn"
                                class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">Add
                                Game</button>
                            <button type="button" id="cancel-edit-game-btn"
                                class="hidden px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schedule List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-xl font-bold">Schedule</h2>
                        <div class="flex gap-4 items-center">
                            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                <input type="checkbox" id="show-practices" class="rounded text-indigo-600">
                                <span>Show Practices</span>
                            </label>
                            <span id="team-name-display" class="text-gray-500"></span>
                        </div>
                    </div>
                    <div id="schedule-list" class="divide-y divide-gray-200">
                        <!-- Games -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <!-- Track Calendar Event Modal -->
    <div id="track-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Track This Game</h3>
            <div id="track-event-details" class="mb-4 text-sm text-gray-600">
                <!-- Event details will be shown here -->
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Opponent Name</label>
                <input type="text" id="track-opponent-input" class="w-full px-3 py-2 border border-gray-300 rounded">
            </div>
            <div class="flex gap-2 justify-end">
                <button id="cancel-track-btn"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancel</button>
                <button id="confirm-track-btn"
                    class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Track Game</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getTeam, getGames, addGame, updateGame, deleteGame, getConfigs, addCalendarToTeam, removeCalendarFromTeam, getTrackedCalendarEventUids } from './js/db.js';
        import { renderHeader, renderFooter, getUrlParams, formatDate, formatTime, fetchAndParseCalendar, extractOpponent, isPracticeEvent } from './js/utils.js?v=7';
        import { checkAuth } from './js/auth.js';
        import { Timestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        renderFooter(document.getElementById('footer-container'));

        let currentTeamId = null;
        let currentUser = null;
        let showPractices = false;
        let selectedCalendarEvent = null;
        let allConfigs = [];

        function mapLink(locationText) {
            if (!locationText) return null;
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationText)}`;
        }

        checkAuth((user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            renderHeader(document.getElementById('header-container'), user);
            init();
        });

        let currentTeam = null;
        function hasAccess(team, user) {
            if (!team || !user) return false;
            if (team.ownerId === user.uid) return true;
            if (user.isAdmin) return true;
            const email = (user.email || '').toLowerCase();
            return (team.adminEmails || []).map(e => e.toLowerCase()).includes(email);
        }

        async function init() {
            const { teamId } = getUrlParams();
            if (!teamId) {
                window.location.href = 'dashboard.html';
                return;
            }
            currentTeamId = teamId;
            document.getElementById('config-link').href = `edit-config.html#teamId=${teamId}`;

            const team = await getTeam(teamId);
            if (!hasAccess(team, currentUser)) {
                alert("Team not found or access denied.");
                window.location.href = 'dashboard.html';
                return;
            }

            currentTeam = team;
            document.getElementById('team-name-display').textContent = team.name;

            // Respect persisted checkbox state on reloads
            const practiceToggle = document.getElementById('show-practices');
            showPractices = practiceToggle?.checked || false;

            loadConfigs();
            renderCalendarManagement();
            loadSchedule();
        }

        async function loadConfigs() {
            allConfigs = await getConfigs(currentTeamId);
            console.log('Loaded configs:', allConfigs);
            const select = document.getElementById('statConfig');

            // Find the default config based on team sport
            let defaultConfigId = null;
            if (currentTeam && currentTeam.sport) {
                const sportLower = currentTeam.sport.toLowerCase();
                console.log('Team sport:', currentTeam.sport, 'lowercase:', sportLower);
                const defaultConfigName = sportLower === 'basketball' ? 'Basketball Standard' :
                    sportLower === 'soccer' ? 'Soccer Standard' : null;
                console.log('Looking for default config:', defaultConfigName);

                if (defaultConfigName) {
                    // Use the configs we just fetched; avoid crashing when defaults are missing
                    const defaultConfig = allConfigs.find(c => c.name === defaultConfigName);
                    console.log('Found default config:', defaultConfig);
                    if (defaultConfig) {
                        defaultConfigId = defaultConfig.id;
                    }
                }
            }

            allConfigs.forEach(config => {
                console.log('Adding config option:', config.name, 'columns:', config.columns);
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = config.name;
                if (config.id === defaultConfigId) {
                    option.selected = true;
                    console.log('Auto-selected config:', config.name);
                }
                select.appendChild(option);
            });
        }

        function renderCalendarManagement() {
            const calendarList = document.getElementById('calendar-list');
            const calendarUrls = currentTeam.calendarUrls || [];

            if (calendarUrls.length === 0) {
                calendarList.innerHTML = '<p class="text-sm text-gray-600 italic">No calendars added yet.</p>';
            } else {
                calendarList.innerHTML = calendarUrls.map((url) => `
                    <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                        <span class="text-sm text-gray-700 truncate flex-grow mr-2">${url}</span>
                        <button onclick="window.removeCalendar('${url}')" class="text-red-600 hover:text-red-800 text-sm">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('');
            }
        }

        async function loadSchedule() {
            const dbGames = await getGames(currentTeamId);
            const container = document.getElementById('schedule-list');
            let allEvents = [];

            // Get tracked calendar event UIDs
            const trackedUids = await getTrackedCalendarEventUids(currentTeamId);

            // Fetch calendar events
            if (currentTeam.calendarUrls && currentTeam.calendarUrls.length > 0) {
                for (const calendarUrl of currentTeam.calendarUrls) {
                    try {
                        const calendarEvents = await fetchAndParseCalendar(calendarUrl);

                        calendarEvents.forEach(event => {
                            // Skip if already tracked
                            if (trackedUids.includes(event.uid)) return;

                            // Skip if conflicts with DB game
                            const hasConflict = dbGames.some(dbGame => {
                                const dbDate = dbGame.date.toDate ? dbGame.date.toDate() : new Date(dbGame.date);
                                const eventDate = event.dtstart;
                                return Math.abs(dbDate - eventDate) < 60000;
                            });
                            if (hasConflict) return;

                            const isPractice = isPracticeEvent(event.summary);
                            const opponent = extractOpponent(event.summary, currentTeam.name);

                            allEvents.push({
                                type: 'calendar',
                                date: event.dtstart,
                                opponent: opponent,
                                location: event.location || 'TBD',
                                isPractice: isPractice,
                                calendarEvent: event
                            });
                        });
                    } catch (error) {
                        console.error('Error fetching calendar:', calendarUrl, error);
                    }
                }
            }

            // Add DB games
            dbGames.forEach(game => {
                const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                allEvents.push({
                    type: 'db',
                    date: gameDate,
                    opponent: game.opponent,
                    location: game.location || 'TBD',
                    status: game.status,
                    homeScore: game.homeScore,
                    awayScore: game.awayScore,
                    gameId: game.id
                });
            });

            // Sort by date
            allEvents.sort((a, b) => a.date - b.date);

            const hiddenPracticeCount = allEvents.filter(event => event.isPractice).length;
            console.log('Aggregated events', { total: allEvents.length, hiddenPracticeCount, showPractices });

            // Filter by practice checkbox
            const filteredEvents = allEvents.filter(event => {
                if (event.isPractice && !showPractices) return false;
                return true;
            });

            const practiceNotice = (!showPractices && hiddenPracticeCount > 0)
                ? `<div class="p-4 bg-yellow-50 text-yellow-800 text-sm border-b border-yellow-200">
                        ${hiddenPracticeCount} practice event${hiddenPracticeCount === 1 ? ' is' : 's are'} hidden. Toggle "Show Practices" to view them.
                   </div>`
                : '';

            if (filteredEvents.length === 0) {
                container.innerHTML = practiceNotice + '<div class="p-6 text-center text-gray-500">No games scheduled.</div>';
                return;
            }

            container.innerHTML = practiceNotice + filteredEvents.map(event => {
                if (event.type === 'calendar') {
                    return renderCalendarEvent(event);
                } else {
                    return renderDbGame(event);
                }
            }).join('');

            // Attach delete button handlers
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (confirm('Are you sure you want to delete this game?')) {
                        await deleteGame(currentTeamId, e.target.dataset.id);
                        loadSchedule();
                    }
                });
            });

            // Attach edit button handlers
            document.querySelectorAll('.edit-game-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const gameId = e.target.dataset.gameId;
                    startEditGame(gameId);
                });
            });
        }

        function renderCalendarEvent(event) {
            const isPractice = event.isPractice;
            return `
                <div class="p-6 hover:bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-l-4 ${isPractice ? 'border-yellow-500' : 'border-blue-500'}">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-semibold">üìÖ Calendar</span>
                            ${isPractice ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-semibold">Practice</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide mb-1">${formatDate(event.date)} ‚Ä¢ ${formatTime(event.date)}</div>
                        <div class="text-lg font-bold text-gray-900">${isPractice ? event.opponent : `vs. ${event.opponent}`}</div>
                        <div class="text-sm text-gray-600">
                            ${mapLink(event.location) ? `<a class="text-indigo-600 hover:underline" target="_blank" rel="noopener noreferrer" href="${mapLink(event.location)}">${event.location || 'TBD'}</a>` : (event.location || 'TBD')}
                        </div>
                    </div>
                    ${!isPractice ? `
                        <button onclick="window.trackCalendarEvent(${JSON.stringify(event.calendarEvent).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">
                            Track
                        </button>
                    ` : ''}
                </div>
            `;
        }

        let editingGameId = null;
        let gamesCache = {};

        function renderDbGame(game) {
            const isCompleted = game.status === 'completed';
            // Cache game data for later retrieval
            gamesCache[game.gameId] = game;
            return `
                <div class="p-6 hover:bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide mb-1">${formatDate(game.date)} ‚Ä¢ ${formatTime(game.date)}</div>
                        <div class="text-lg font-bold text-gray-900">vs. ${game.opponent}</div>
                        <div class="text-sm text-gray-600">
                            ${mapLink(game.location) ? `<a class="text-indigo-600 hover:underline" target="_blank" rel="noopener noreferrer" href="${mapLink(game.location)}">${game.location || 'TBD'}</a>` : (game.location || 'TBD')}
                        </div>
                        ${isCompleted ? `<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-semibold mt-2">Final: ${game.homeScore}-${game.awayScore}</span>` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button data-game-id="${game.gameId}" class="edit-game-btn px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">Edit</button>
                        <a href="track.html#teamId=${currentTeamId}&gameId=${game.gameId}" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">Track</a>
                        ${isCompleted ? `<a href="game.html#teamId=${currentTeamId}&gameId=${game.gameId}" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200">Report</a>` : ''}
                        <a href="game-plan.html#teamId=${currentTeamId}&gameId=${game.gameId}" class="px-3 py-1 bg-primary-100 text-primary-700 rounded text-sm hover:bg-primary-200">Game Plan</a>
                        <button data-id="${game.gameId}" class="px-3 py-1 border border-red-300 text-red-600 rounded text-sm hover:bg-red-50 delete-btn">Delete</button>
                    </div>
                </div>
            `;
        }

        function startEditGame(gameId) {
            const game = gamesCache[gameId];
            if (!game) return;
            editingGameId = game.gameId;

            // Populate form
            const date = game.date.toDate ? game.date.toDate() : new Date(game.date);
            // Format for datetime-local input: YYYY-MM-DDThh:mm
            const dateStr = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

            document.getElementById('gameDate').value = dateStr;
            document.getElementById('opponent').value = game.opponent || '';
            document.getElementById('location').value = game.location || '';
            document.getElementById('statConfig').value = game.statTrackerConfigId || '';

            // Update UI
            document.getElementById('submit-game-btn').textContent = 'Update Game';
            document.getElementById('cancel-edit-game-btn').classList.remove('hidden');

            // Scroll to form
            document.getElementById('add-game-form').scrollIntoView({ behavior: 'smooth' });
        };

        function resetGameForm() {
            editingGameId = null;
            document.getElementById('add-game-form').reset();
            document.getElementById('submit-game-btn').textContent = 'Add Game';
            document.getElementById('cancel-edit-game-btn').classList.add('hidden');
        }

        document.getElementById('cancel-edit-game-btn').addEventListener('click', resetGameForm);

        document.getElementById('add-game-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dateVal = document.getElementById('gameDate').value;
            const opponent = document.getElementById('opponent').value;
            const location = document.getElementById('location').value;
            const configId = document.getElementById('statConfig').value;

            if (!dateVal) return;

            try {
                const gameData = {
                    date: Timestamp.fromDate(new Date(dateVal)),
                    opponent,
                    location,
                    statTrackerConfigId: configId || null
                };

                if (editingGameId) {
                    await updateGame(currentTeamId, editingGameId, gameData);
                } else {
                    gameData.status = 'scheduled';
                    gameData.homeScore = 0;
                    gameData.awayScore = 0;
                    await addGame(currentTeamId, gameData);
                }

                resetGameForm();
                loadSchedule();
            } catch (error) {
                console.error(error);
                alert('Error saving game: ' + error.message);
            }
        });

        // Calendar Management Event Handlers
        document.getElementById('add-calendar-btn').addEventListener('click', () => {
            document.getElementById('add-calendar-form').classList.remove('hidden');
            document.getElementById('calendar-url-input').focus();
        });

        document.getElementById('cancel-calendar-btn').addEventListener('click', () => {
            document.getElementById('add-calendar-form').classList.add('hidden');
            document.getElementById('calendar-url-input').value = '';
        });

        document.getElementById('save-calendar-btn').addEventListener('click', async () => {
            const url = document.getElementById('calendar-url-input').value.trim();
            if (!url) {
                alert('Please enter a calendar URL');
                return;
            }

            if (!url.includes('.ics')) {
                alert('Please enter a valid .ics calendar URL (must include .ics)');
                return;
            }

            try {
                await addCalendarToTeam(currentTeamId, url);
                document.getElementById('add-calendar-form').classList.add('hidden');
                document.getElementById('calendar-url-input').value = '';

                // Reload team and schedule
                currentTeam = await getTeam(currentTeamId);
                renderCalendarManagement();
                loadSchedule();
            } catch (error) {
                alert('Error adding calendar: ' + error.message);
            }
        });

        window.removeCalendar = async (url) => {
            if (!confirm('Remove this calendar?')) return;

            try {
                await removeCalendarFromTeam(currentTeamId, url);
                currentTeam = await getTeam(currentTeamId);
                renderCalendarManagement();
                loadSchedule();
            } catch (error) {
                alert('Error removing calendar: ' + error.message);
            }
        };

        // Practice filter
        document.getElementById('show-practices').addEventListener('change', (e) => {
            showPractices = e.target.checked;
            loadSchedule();
        });

        // Track calendar event - create game and redirect to tracker
        window.trackCalendarEvent = async (calendarEvent) => {
            try {
                const opponent = extractOpponent(calendarEvent.summary, currentTeam.name);
                const configId = document.getElementById('statConfig').value;

                // Create game in DB
                const eventDate = calendarEvent.dtstart;
                const timestamp = Timestamp.fromDate(new Date(eventDate));

                const gameId = await addGame(currentTeamId, {
                    date: timestamp,
                    opponent: opponent,
                    location: calendarEvent.location || '',
                    statTrackerConfigId: configId || null,
                    status: 'scheduled',
                    homeScore: 0,
                    awayScore: 0,
                    calendarEventUid: calendarEvent.uid
                });

                // Redirect to stat tracker
                window.location.href = `track.html#teamId=${currentTeamId}&gameId=${gameId}`;
            } catch (error) {
                console.error('Error tracking game:', error);
                alert('Error tracking game: ' + error.message);
            }
        };
    </script>
</body>

</html>
