<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J13LHWFT3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3J13LHWFT3');
  </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo_small.png">
    <title>Login - ALL PLAYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 flex flex-col min-h-screen">
    <div id="header-container"></div>

    <main class="flex-grow flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 id="form-title" class="text-2xl font-bold mb-6 text-center">Login</h1>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                </div>
                <div id="confirm-password-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
                    <input type="password" id="confirm-password"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                </div>
                <div id="activation-code-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Activation Code</label>
                    <input type="text" id="activation-code"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2 uppercase"
                        placeholder="Enter your 8-character code" maxlength="8">
                    <p class="mt-1 text-xs text-gray-500">Enter the activation code provided to you</p>
                </div>
                <div id="error-message" class="text-red-500 text-sm hidden"></div>
                <button type="submit" id="submit-btn"
                    class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">Sign
                    In</button>
            </form>
            <div class="mt-4">
                <button id="google-btn"
                    class="w-full flex items-center justify-center gap-2 border border-gray-300 py-2 px-4 rounded-md hover:bg-gray-50 transition text-sm font-medium text-gray-700">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt=""
                        class="w-5 h-5">
                    <span>Continue with Google</span>
                </button>
            </div>
            <div id="forgot-password-link" class="mt-4 text-center text-sm">
                <button id="forgot-password-btn" class="text-indigo-600 hover:underline text-sm">Forgot
                    Password?</button>
            </div>
            <div class="mt-4 text-center text-sm">
                <span id="toggle-text">Don't have an account?</span>
                <button id="toggle-btn" class="text-indigo-600 hover:underline font-medium">Sign Up</button>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script type="module">
        import { login, signup, checkAuth, loginWithGoogle, handleGoogleRedirectResult, resetPassword, getRedirectUrl } from './js/auth.js?v=7';
        import { getUserProfile } from './js/db.js';
        import { renderHeader, renderFooter } from './js/utils.js?v=8';

        renderFooter(document.getElementById('footer-container'));

        let isLogin = true;
        let isProcessingAuth = false; // Flag to prevent auto-redirect during login/signup

        // Handle Google redirect result on page load
        (async () => {
            // Block checkAuth auto-redirect until we finish validating redirect result
            isProcessingAuth = true;
            console.log('[Login Page] Starting Google redirect result check');

            const errorDiv = document.getElementById('error-message');
            try {
                const result = await handleGoogleRedirectResult();
                console.log('[Login Page] handleGoogleRedirectResult returned:', result ? 'Result found' : 'No result');

                if (result && result.user) {
                    console.log('[Login Page] User found, fetching profile for:', result.user.email);
                    // User just returned from Google sign-in
                    const profile = await getUserProfile(result.user.uid);
                    console.log('[Login Page] Profile fetched:', profile);
                    const userWithRoles = { ...result.user, ...profile };
                    const redirectUrl = getRedirectUrl(userWithRoles);
                    console.log('[Login Page] Redirecting to:', redirectUrl);
                    window.location.href = redirectUrl;
                    return; // Prevent further initialization
                } else {
                    console.log('[Login Page] No redirect result - normal page load');
                }
            } catch (error) {
                // Show error from Google sign-in
                console.error('[Login Page] Error during Google redirect handling:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                console.error('Google redirect error:', error);
            } finally {
                // Always clear the processing flag so checkAuth can work normally
                console.log('[Login Page] Clearing isProcessingAuth flag');
                isProcessingAuth = false;
            }
        })();

        checkAuth((user) => {
            // Only auto-redirect if not currently processing login/signup
            if (user && !isProcessingAuth) {
                window.location.href = getRedirectUrl(user);
            }
            renderHeader(document.getElementById('header-container'), user);
        });

        document.getElementById('toggle-btn').addEventListener('click', () => {
            isLogin = !isLogin;
            document.getElementById('form-title').textContent = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('submit-btn').textContent = isLogin ? 'Sign In' : 'Create Account';
            document.getElementById('toggle-text').textContent = isLogin ? "Don't have an account?" : "Already have an account?";
            document.getElementById('toggle-btn').textContent = isLogin ? 'Sign Up' : 'Login';
            document.getElementById('error-message').classList.add('hidden');

            // Show/hide confirm password field
            const confirmPasswordField = document.getElementById('confirm-password-field');
            const confirmPasswordInput = document.getElementById('confirm-password');

            // Show/hide activation code field
            const activationCodeField = document.getElementById('activation-code-field');
            const activationCodeInput = document.getElementById('activation-code');

            // Show/hide forgot password link
            const forgotPasswordLink = document.getElementById('forgot-password-link');

            if (isLogin) {
                confirmPasswordField.classList.add('hidden');
                confirmPasswordInput.removeAttribute('required');
                activationCodeField.classList.add('hidden');
                activationCodeInput.removeAttribute('required');
                forgotPasswordLink.classList.remove('hidden');
            } else {
                confirmPasswordField.classList.remove('hidden');
                confirmPasswordInput.setAttribute('required', 'required');
                activationCodeField.classList.remove('hidden');
                activationCodeInput.setAttribute('required', 'required');
                forgotPasswordLink.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');

            isProcessingAuth = true; // Prevent auto-redirect during process

            try {
                if (isLogin) {
                    const userCredential = await login(email, password);
                    // Fetch profile to determine redirect
                    const profile = await getUserProfile(userCredential.user.uid);
                    const userWithRoles = { ...userCredential.user, ...profile };
                    window.location.href = getRedirectUrl(userWithRoles);
                } else {
                    // Signup mode - validate password confirmation
                    const confirmPassword = document.getElementById('confirm-password').value;
                    if (password !== confirmPassword) {
                        throw new Error('Passwords do not match');
                    }

                    const activationCode = document.getElementById('activation-code').value.trim().toUpperCase();
                    if (!activationCode) {
                        throw new Error('Activation code is required');
                    }
                    await signup(email, password, activationCode);
                    // Signup - redirect to email verification page
                    window.location.href = 'verify-pending.html';
                    return;
                }
            } catch (error) {
                isProcessingAuth = false; // Reset flag on error
                errorDiv.textContent = error.message; // Show actual error
                errorDiv.classList.remove('hidden');
                console.error(error);
            }
        });

        document.getElementById('google-btn').addEventListener('click', async () => {
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.add('hidden');

            try {
                // If in signup mode, validate activation code before starting auth
                let activationCode = null;
                if (!isLogin) {
                    activationCode = document.getElementById('activation-code').value.trim().toUpperCase();
                    if (!activationCode) {
                        throw new Error('Activation code is required for new accounts');
                    }
                }

                // Hybrid flow: tries popup first, falls back to redirect if blocked
                const result = await loginWithGoogle(activationCode);

                // If popup succeeded, result is returned directly - handle redirect
                if (result && result.user) {
                    console.log('[Login Page] Popup succeeded, redirecting...');
                    const profile = await getUserProfile(result.user.uid);
                    const userWithRoles = { ...result.user, ...profile };
                    window.location.href = getRedirectUrl(userWithRoles);
                }
                // If result is null, redirect flow was triggered - page will reload
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                console.error(error);
            }
        });

        document.getElementById('forgot-password-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.add('hidden');

            if (!email) {
                errorDiv.textContent = 'Please enter your email address';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Firebase will validate if the email exists in Auth
                // No need to check Firestore - user may exist in Auth but not in DB
                await resetPassword(email);

                // Clear the email field for security
                document.getElementById('email').value = '';

                errorDiv.classList.remove('hidden');
                errorDiv.classList.remove('text-red-500');
                errorDiv.classList.add('text-green-600');
                errorDiv.textContent = 'Password reset email sent! Please check your inbox and spam folder.';
            } catch (error) {
                errorDiv.classList.remove('text-green-600');
                errorDiv.classList.add('text-red-500');

                // Handle specific Firebase error codes
                let errorMessage = error.message;
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many requests. Please try again later.';
                }

                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('hidden');
                console.error('Password reset error:', error);
            }
        });
    </script>
</body>

</html>