<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J13LHWFT3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3J13LHWFT3');
  </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo_small.png">
    <title>Parent Dashboard - ALL PLAYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900">
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-8 md:py-12">
        <!-- Page Header -->
        <div class="mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-2 bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent">Parent Dashboard</h1>
            <p class="text-gray-600 text-sm md:text-base">Track your athletes' schedules and stats.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: My Players -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h2 class="text-lg font-bold text-gray-900">My Players</h2>
                    </div>
                    <div id="my-players-list" class="p-4 space-y-4">
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading players...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Coach Invite Info -->
                <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                    <h3 class="font-semibold text-blue-900 mb-2">Need to add another player?</h3>
                    <p class="text-sm text-blue-800">Ask the coach to send you an invite code for that player. Once you have it, you can redeem it here.</p>
                    <div class="mt-4">
                        <input type="text" id="redeem-code-input" placeholder="Enter Invite Code" class="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm mb-2 uppercase">
                        <button id="redeem-code-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">Redeem Code</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Combined Schedule -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden min-h-[500px]">
                    <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-900">Upcoming Schedule</h2>
                        <span class="text-xs font-medium bg-white px-2 py-1 rounded border border-gray-200 text-gray-500">All Teams</span>
                    </div>
                    <div id="schedule-list" class="divide-y divide-gray-100">
                        <div class="text-center py-12">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script type="module">
        import { getParentDashboardData, redeemParentInvite, getTeam, getGames, getTrackedCalendarEventUids } from './js/db.js?v=2';
        import { renderHeader, renderFooter, escapeHtml, fetchAndParseCalendar, extractOpponent, isPracticeEvent } from './js/utils.js?v=7';
        import { requireAuth, checkAuth } from './js/auth.js';

        renderFooter(document.getElementById('footer-container'));

        async function init() {
            try {
                const user = await requireAuth();
                
                // Allow checkAuth to populate user object fully
                checkAuth((updatedUser) => {
                     renderHeader(document.getElementById('header-container'), updatedUser);
                });

                const data = await getParentDashboardData(user.uid);
                renderPlayers(data.children);
                const combinedSchedule = await buildCombinedSchedule(data.children);
                renderSchedule(combinedSchedule);

                // Redeem Code Logic
                document.getElementById('redeem-code-btn').addEventListener('click', async () => {
                    const code = document.getElementById('redeem-code-input').value.trim();
                    if(!code) return alert('Please enter a code');
                    
                    const btn = document.getElementById('redeem-code-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Processing...';
                    btn.disabled = true;

                    try {
                        await redeemParentInvite(user.uid, code);
                        alert('Player added successfully!');
                        location.reload();
                    } catch (e) {
                        alert('Error: ' + e.message);
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                });

            } catch (error) {
                console.error(error);
            }
        }

        async function buildCombinedSchedule(children) {
            if (!children || children.length === 0) return [];

            const byTeam = new Map();
            for (const child of children) {
                if (!child.teamId) continue;
                if (!byTeam.has(child.teamId)) {
                    byTeam.set(child.teamId, []);
                }
                byTeam.get(child.teamId).push(child);
            }

            const allEvents = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (const [teamId, teamChildren] of byTeam.entries()) {
                const team = await getTeam(teamId);
                if (!team) continue;

                const dbGames = await getGames(teamId);
                const trackedUids = await getTrackedCalendarEventUids(teamId);

                // DB games for this team
                for (const game of dbGames) {
                    const date = game.date?.toDate ? game.date.toDate() : new Date(game.date);
                    if (date < today) continue;
                    const isPractice = game.type === 'practice';
                    const type = isPractice ? 'practice' : 'game';
                    const location = game.location || 'TBD';
                    const opponent = game.opponent || 'TBD';
                    const id = game.id || game.gameId;

                    for (const child of teamChildren) {
                        allEvents.push({
                            type,
                            date,
                            location,
                            opponent,
                            teamId,
                            id,
                            childName: child.playerName
                        });
                    }
                }

                // Calendar (ICS) events for this team
                if (team.calendarUrls && team.calendarUrls.length > 0) {
                    for (const calendarUrl of team.calendarUrls) {
                        try {
                            const calendarEvents = await fetchAndParseCalendar(calendarUrl);

                            calendarEvents.forEach(event => {
                                if (trackedUids.includes(event.uid)) return;

                                const eventDate = event.dtstart;
                                if (!eventDate || eventDate < today) return;

                                // Skip if a DB game already occupies this slot (within 1 minute)
                                const hasConflict = dbGames.some(dbGame => {
                                    const dbDate = dbGame.date?.toDate ? dbGame.date.toDate() : new Date(dbGame.date);
                                    return Math.abs(dbDate - eventDate) < 60000;
                                });
                                if (hasConflict) return;

                                const isPractice = isPracticeEvent(event.summary);
                                const opponent = extractOpponent(event.summary, team.name);
                                const location = event.location || 'TBD';
                                const type = isPractice ? 'practice' : 'game';

                                for (const child of teamChildren) {
                                    allEvents.push({
                                        type,
                                        date: eventDate,
                                        location,
                                        opponent,
                                        teamId,
                                        id: event.uid || null,
                                        childName: child.playerName
                                    });
                                }
                            });
                        } catch (err) {
                            console.error('Error fetching calendar for parent dashboard:', calendarUrl, err);
                        }
                    }
                }
            }

            allEvents.sort((a, b) => a.date - b.date);
            return allEvents;
        }

        function renderPlayers(children) {
            const container = document.getElementById('my-players-list');
            if (!children || children.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500 text-sm">No players linked yet.</div>`;
                return;
            }

            container.innerHTML = children.map(child => `
                <a href="player.html?teamId=${child.teamId}&playerId=${child.playerId}" 
                   class="flex items-center gap-4 p-3 rounded-xl border border-gray-200 hover:border-primary-300 hover:bg-primary-50 transition group">
                    <div class="h-12 w-12 flex-shrink-0 rounded-full bg-gray-200 overflow-hidden border border-gray-300">
                        ${child.playerPhotoUrl 
                            ? `<img src="${escapeHtml(child.playerPhotoUrl)}" class="w-full h-full object-cover">` 
                            : `<div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No Img</div>`
                        }
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="font-bold text-gray-900 group-hover:text-primary-700 truncate">${escapeHtml(child.playerName)}</div>
                        <div class="text-xs text-gray-500 truncate">${escapeHtml(child.teamName)}</div>
                    </div>
                    <div class="flex-shrink-0 text-gray-300 group-hover:text-primary-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </a>
            `).join('');
        }

        function renderSchedule(games) {
            const container = document.getElementById('schedule-list');
            if (!games || games.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-gray-500">No upcoming games scheduled.</p>
                    </div>
                `;
                return;
            }

            const now = new Date(); // To highlight today/tomorrow

            container.innerHTML = games.map(game => {
                const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                const dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const typeLabel = game.type === 'practice' ? 'Practice' : 'Game';
                const typeColor = game.type === 'practice' ? 'bg-amber-100 text-amber-800' : 'bg-primary-100 text-primary-800';
                
                return `
                <div class="p-6 hover:bg-gray-50 transition flex flex-col sm:flex-row gap-4 sm:items-center">
                    <div class="flex-shrink-0 w-24 text-center sm:text-left">
                        <div class="text-sm font-bold text-gray-900 uppercase">${dateStr}</div>
                        <div class="text-xs text-gray-500">${timeStr}</div>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide ${typeColor}">
                                ${typeLabel}
                            </span>
                            <span class="text-xs text-gray-400 font-medium">For ${escapeHtml(game.childName || 'Player')}</span>
                        </div>
                        <div class="font-bold text-gray-900 text-lg">
                            ${game.type === 'practice' 
                                ? escapeHtml(game.title || 'Practice') 
                                : `vs. ${escapeHtml(game.opponent || 'TBD')}`}
                        </div>
                        <div class="text-sm text-gray-500 flex items-center gap-1 mt-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            ${escapeHtml(game.location || 'TBD')}
                        </div>
                    </div>
                    <div class="flex-shrink-0 text-right">
                         <a href="game.html?teamId=${game.teamId}&gameId=${game.id}" 
                            class="inline-flex items-center gap-1 text-sm font-medium text-primary-600 hover:text-primary-700">
                             View Details
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                         </a>
                    </div>
                </div>
            `}).join('');
        }

        init();
    </script>
</body>

</html>
